---
layout: post
name: "Bad USB #0 - Les bases"
title: "Bad USB #0 - Les bases"
tags: crack USB embedded baremetal
---

# [Bad USB] #0 - Les bases

<br>
<p style="text-align:center;">
    <u>Objectif:</u> Implementer un BadUSB.<br>
</p>
<div style="text-align: center;">
    <img src="{{site.baseurl}}/assets/img/usb/main.PNG" width="300" alt="">
</div>
<br>
C'est quoi un BadUSB? <br>
Je vais essayer de faire court, promis. <br>

{% include sep.html %}

### C'est quoi l'USB?

- Introduit en Janvier 1996,
- Acronyme de <b>U</b>niversal <b>S</b>erial <b>B</b>us.
- Interface de <b>communication</b> pouvant servir d'<b>alimententation</b>.
- Norme qui d√©finit et englobe:
  - le protocole de communication,
  - les caract√©ristiques du c√¢ble,
  - le design du connecteur.
  - l'int√©gration mat√©rielle,
  - l'architecture logicielle,
  - les signaux √©lectriques. 

{% include sep.html %}

### Pour la petite histoire.

<div style="text-align: justify">
La norme USB est devenu LA NORME pour connecter des dispositifs aujourd'hui. Et m√™me si le hub, et la conception m√™me de l'USB peuvent arbitrer et/ou int√©grer plusieurs dispositifs √† la fois, √ßa reste tout de m√™me du s√©rie.
</div>
> D'un point A... <br>
> A un point B. <br>

<div style="text-align: justify">
Simple, pr√©cis. Mais √ßa remonte d√©j√† aux ann√©es 60, avec le le fameux <i>RS232</i>, issu du consortium entre plusieurs grosses bo√Ætes am√©ricaines; citons <b>IBM</b>, <b>Motorola</b>, <b>TexasInstruments</b>, <b>General Electrics</b>, <b>Intel</b>.
<br> <br>
<details>
    <summary>Oui bon c'est pas parce que je suis fan hein, mais attention spoiler:</summary>
    <br>
    <p style="margin-left:50px">C'est toujours les m√™mes bo√Ætes am√©ricaines dans l'histoire. <br>
	Un jour je parlerai de l'essor de l'imp√©rialisme am√©ricain √† base de corporatisme tech' üòè </p>
</details>
<br>

<div style="display: flex; align-items: flex-start; text-align: justify;">
    <div style="flex: 1;">
        <br>
        <p>
            Le truc a √©t√© repris, nottament avec le PS/2 d'<b>IBM</b> qui restera √† jamais dans nos coeurs avec son design rond, lila et vert pomme (2 connecteurs avec 6 pins chacun). Y avait aussi <b>Apple</b> et son <i>FireWire</i>, en 6 ou 4 broches, rien de sensationnel cependant.
        </p>
        <p>
            Dans le m√™me temps sont arriv√©s des... trucs... parall√®les qu'ils disent:
            <ul>
                <li> Le <b>Centronix</b>, de la boite (emoji USA) du m√™me nom, et son connecteur √† 36 pins... puis son √©volution en ECP et EPP (Parallel), avec 25 pinoches. </li>
                <li> Le <b>SCSI</b>, venu d'un consortium concurrent... Toujours des am√©ricains. Ils ont mis 50 pins les bougres. </li>
            </ul>
        </p>
    </div>
    <div style="flex: 0 0 auto; margin-left: 20px;">
        <img src="{{site.baseurl}}/assets/img/usb/parallel.PNG" style="width: 250px;" alt="">
    </div>
</div>

{% include sep.html %}

Puis en 1995, un consortium des plus grands de la tech se fonde, l'<b>USB-IF</b>. <br>
Le gr√¢tin de la tech, le Foxhound des bus universel disons-le, et en un an, il te pondent 
l'<b>USB-A 1.0</b>. S'en est suivi la construction du monopole des connecteurs, avec son consort de nouvelles versions, que ce soit hardware ou software.
</div>

<div style="text-align: center;">
    <img src="{{site.baseurl}}/assets/img/usb/usb_if.PNG" width="300" alt="">
</div>
<br>
Aujourd'hui il y a √©norm√©ment de d√©nominations.. <br>
<i>USB-A, B, C, mini, micro, 1.0, 2.0, 3.0, FS, HS, OTG, PD</i> etc... <br>
Je ne vais cependant pas m'attarder l√†-dessus parce que ce serait beaucoup trop long, et c'est pas le sujet.

{% include sep.html %}

### Notions importantes

<div style="display: flex; align-items: flex-start; text-align: justify;">
    <div style="flex: 1;">
        <p style="margin-top: 0;">
            Commentons le point qui, selon moi, est le plus important de l'USB. Sa g√©n√©ricit√©. C'est d'ailleurs ce qui lui a permis de se r√©pandre aussi largement.
        </p>
        <p style="margin-top: 0;">
            Regardez-moi la quantit√© de dispositifs diff√©rent qu'il supporte.
        </p>
        <p style="margin-top: 0;">
            D'un point de vue technique, tout √ßa se base sur ce que la norme USB d√©finit comme la <i>classe</i>. Et des classes, il y en a <a href="https://www.usb.org/defined-class-codes">un paquet</a>.
        </p>
        <p style="margin-top: 0;">
            Parmis ces classes, les plus communes sont: <ul>
            <li> <b>Mass Storage Device</b> (la fameuse clef USB). </li>
            <li> <b>Human Interface Device</b> (la souris, le clavier).</li>
            <li> <b>Audio Device</b> (le casque audio, l'ampli). </li> </ul>
        </p>
        <details>
            <summary>Il existe m√™me une classe pour faire du port s√©rie üòÇ</summary>
            <img src="{{site.baseurl}}/assets/img/usb/usb_cdc.PNG" style="width: 250px;" alt="">
        </details>
    </div>
    <div style="flex: 0 0 auto; margin-left: 20px;">
      <img src="{{site.baseurl}}/assets/img/usb/usb_class.png" alt="" style="float: right; margin-left: 20px; width: 110px;">
    </div>
</div>

{% include sep.html %}

<div style="display: flex; align-items: flex-start; text-align: justify;">
    <div style="flex: 1 1 100px;">
        <img src="{{site.baseurl}}/assets/img/usb/usb_endpoints.png" alt="">
    </div>
    <div style="flex: 1; margin-left: 10px;">
        <p style="margin-top: 0;">
            Derri√®re cette notion de classe, il y a le concept de <b>End-point</b>, et il en existe 4 types: <ul>
            <li> <i>Control</i>, pas trop besoin d'en rajouter sur ce point.</li>
            <li> <i>Bulk</i>, avec correction d'erreur, et en grande quantit√©.</li>
            <li> <i>Interrupt</i>, rapide, mais en petite quantit√©.</li>
            <li> <i>Isochronous</i>, temps-r√©el, peu importe l'int√©grit√©.</li></ul>
        </p>
    </div>
</div>
<br>
<details>
    <summary>Les plus affut√©s du tiroir sauront facilement me dire quel type est le plus optimis√© pour une clef USB? Une souris? Un clavier? Un casque audio?</summary>
    <ul>
        <li> Toutes les classes disposent d'un end-point de Control.</li>
        <li> <b>Mass Storage Device</b> (la fameuse clef USB) utilise des EP Bulk IN et OUT.</li>
        <li> <b>Human Interface Device</b> (la souris, le clavier) utilise des EP Interrupt IN.</li>
        <li> <b>Audio Device</b> (le casque audio, l'ampli) utilise des EP Isochronous IN et OUT.</li>
    </ul>
</details>
<br>
<p style="text-align: justify;">
    Un autre point important dans notre cas; le <i>USB Composite Device</i>, auquel j'ai d√©j√† fait
    r√©f√©rence pr√©cedemment. C'est le fait d'int√©grer plusieurs dispositifs √† la fois dans un m√™me dispositif. Maintenant que tu sais ce qu'est une classe, j'imagine que tu vois l'id√©e. <br>
    N√©anmoins nous allons laisser √ßa pour le moment et y reviendrons plus tard dans cette article.
</p>

{% include sep.html %}

### Dans le vif du sujet

<p style="text-align: justify;">
    Si tu tapes "<b>BadUSB</b>" sur google, rapidement tu verras parler d'HID (<i>jusque l√† toi devoir comprendre</i> üòò), de payloads (les trucs envoy√©s par le HID), de <b>Rubber Ducky</b> (un utilitaire pour g√©n√©rer des payloads), mais aussi <b>et surtout</b> du chip USB 2.0 <b>Phison 2303</b>...
</p>
<p style="text-align: justify;">
    Mais pourquoi ce chip en particulier? Pour [ce repository github](https://github.com/flowswitch/phison) qui fournit toutes les instructions pour reprogrammer la flash du micro, ainsi qu'un firmware custom pour envoyer des payloads pr√©-programm√©s en tant que dispositif HID.
</p>
<div style="text-align: center;">
    <img src="{{site.baseurl}}/assets/img/usb/phison2303.PNG" width="500" alt="">
</div>
<br>
<p style="text-align: justify;">
    <b>Alors</b> j'ai mis une petite t√™te de mort, parce que le chip n'est plus en production, et la documentation introuvable (<b>la datasheet ne suffit JAAAAAMAAAAIS</b>). Ca aurait √©t√© vraiment cool de pouvoir regarder comment c'est mont√© derri√®re, mais d√©j√† on peut affirmer que: 
    <ul>
        <li> Phison c'est des üêÄ, ils filent vraiment aucune doc'.</li>
        <li> Le propri√©taire du repo github devait avoir une dent contre eux (et la doc' aussi apparemment üòÇ).</li>
    </ul>
</p>

{% include sep.html %}

<div style="display: flex; align-items: flex-start; text-align: justify;">
    <div style="flex: 1 1 100px;">
        <img src="{{site.baseurl}}/assets/img/usb/datasheet.png" alt="">
    </div>
    <div style="flex: 1; margin-left: 20px">
    <p>
        Ce n'√©tait cependant pas un chip vuln√©rable, il l'est devenu parce que son design et ses sp√©cifications techniques ont fuit√©.. D'ailleurs, c'est potentiellement faisable sur n'importe quel micro, si tent√© qu'il dispose du hardware n√©cessaire pour monter le HID.
    </p>
    <p>
        Toutes les clefs USB dans votre tiroir peuvent √™tre reprogramm√©es. Par contre toutes n'ont pas la capacit√© de monter un <b>BadUSB</b>.
    </p>
    <p>
        Allez savoir pourquoi, le Phison 2303, qui se vend comme Flash Controller, pour du stockage donc, dispose d'un EP Interrupt ü§∑‚Äç‚ôÇÔ∏è.
    </p>
    </div>
</div>
<p style="text-align: justify;">
    Franchement, conna√Ætre la petite histoire m'int√©resserait beaucoup (et voir la documentation aussi). Si j'ai du temps √† perdre, j'irai me perdre sur le moteur de recherche chinois √† voir si y a pas une histoire croustillante. Je vous promet rien, la Chimay est plus en promo √† Carrefour (l'a-t-elle d√©j√† √©t√©).
</p>

{% include sep.html %}

### La suite...

<div style="text-align: justify;">
    Notre id√©e est quelque peu diff√©rente √† un <b>BadUSB</b> conventionnel:
    <ul>
        <li> Premi√®rement, et c'est un peu mon <i>leitmotiv</i>, je ne veux pas utiliser du code que je ne comprends pas.</li>
        <li> Ensuite, je veux absolument conserver cette approche <i>mat√©rielle</i> de la conception, et impliquer le moins d'API, ou de third-party libraries possible. </li>
        <li> Dans cette id√©e, je ne compte pas acheter une clef USB avec un Phison 2303 pour la reprogrammer, et encore moins acheter un <b>BadUSB</b> tout fait (environ 70 boules). </li>
    </ul>
    D'autant que le dispositif conventionnel ne maintient pas du tout la fonctionnalit√© premi√®re qui est le stockage; je veux absolument d√©velopper un USB composite, afin de conserver cette fonctionnalit√© de clef USB en plus du clavier fant√¥me. <br> <br>
    J'en trouverai bien l'utilit√© plus tard. <br>
    Pour le moment je dois donc trouver un MCU (Micro Controler Unit) qui me permette d'impl√©menter un device USB avec ces deux classes (MSC pour la clef et HID pour le clavier).
</div>

{% include sep.html %}

<div style="display: flex; align-items: flex-start;">
    <div style="flex: 1; text-align: justify; margin-left: 100px; margin-right: 40px">
        <p>
            J'ai bien <b>STM32</b> en t√™te, mais je vais tout de m√™me jeter un coup d'üëÄ du c√¥t√© de <b>NXP</b>, <b>Microchip</b>, <b>TexasInstruments</b> et consorts.
            <br><br> 
            Je reviens vite. <br>
            Des zoubi. <br>
            <b>~~</b>
        </p>
    </div>
    <div style="flex: 1;">
        <img src="{{site.baseurl}}/assets/img/usb/duck_buy.gif" alt="">
    </div>
</div>

{% include foot.html %}